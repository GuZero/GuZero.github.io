<!DOCTYPE html>
<html lang="en" ng-app="myApp" ng-controller="mainCtrl">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="lib/ionic/css/ionic.css">
    <style>

    </style>
</head>
<body>
    <div class="bar bar-header bar-positive">
        <button class="button" ng-click="flag=!flag">
            <span ng-if="!flag">删除</span>
            <span ng-if="flag">取消</span>
        </button>
        <h3 class="title">ionic 爱段子</h3>
        <button class="button" ng-click="clear()">重置</button>
    </div>
    <ion-content class="has-footer has-header ">
        <ion-refresher pulling-text="下拉刷新" on-refresh="doRefresh()"></ion-refresher>
        <ion-list show-delete="flag" show-reorder="flag" can-swipe="true">
            <ion-item ng-repeat="item in items track by $index" class="item-text-wrap">

                <h2 class="title text-center">{{item.title}}</h2>
                <br/>
                <br/>
                {{item.summary}}
                <ion-delete-button class="ion-minus-circled" ng-click="deleteItme(item)"></ion-delete-button>
                <ion-option-button
                        class="button button-assertive"
                        ng-click="deleteItme(item)"
                >
                    删除
                </ion-option-button>
                <ion-option-button class="button button-energized">分享</ion-option-button>
                <ion-option-button class="button button-stable" ng-click="toTop(item)">置顶</ion-option-button>
            </ion-item>
        </ion-list>
    </ion-content>

    <div class="bar bar-footer bar-stable">
        <h3 class="title">别点俺，俺就是个摆设</h3>
    </div>
<script src="lib/ionic/js/ionic.bundle.js"></script>
<script>
    angular.module("myApp",["ionic"]).controller("mainCtrl",["$scope","$http","$ionicListDelegate","$funService",function ($scope,$http,$ionicListDelegate,$funService) {
       $scope.flag=false;
        $scope.items=$funService.fetchData("datalist");
        $scope.page=$funService.fetchData("page")||0;
        $scope.getData=function () {
            $scope.page++;
            $http.get("http://www.qingkt.com/duan/data.php?page="+$scope.page)
                .success(function (res) {
                    $scope.items=res.result.concat($scope.items);
                    console.log($scope.items);
                    $funService.saveData("datalist",$scope.items);
                    $funService.saveData("page",$scope.page);
                });
        }
        if($scope.items.length<=0){$scope.getData()};
        // 当下拉的时候执行
        $scope.doRefresh=function(){
            $scope.getData();//拿到数据
            $scope.$broadcast("scroll.refreshComplete")
            //广播完成
        }

        $scope.deleteItme=function (item) {
            var index=$scope.items.indexOf(item);
            $scope.items.splice(index,1);
        }
        $scope.toTop=function (item) {
            $scope.deleteItme(item);
            $scope.items.splice(0,0,item);
            $ionicListDelegate.closeOptionButtons();

        }

//        清空缓存
        $scope.clear=function () {
            $funService.clearData("datalist");
            $scope.page=0;
            $scope.getData();
        }




    }]).factory("$funService",[function(){
        return {
            //保存数据
            saveData:function(name,value){
                // 把value对象转换为一个字符串
//                var str =JSON.stringify(value);
                // 存储在本地
                localStorage.setItem(name,angular.toJson(value));
            },
            // 获取数据组
            fetchData:function(name){
//						返回一个对象
                //localStorage.getItem(name) 拿到字符串 需要转为 json格式 如果拿不到就给一个[]
                return JSON.parse(localStorage.getItem(name)||"[]");

            },
            clearData:function (name) {
                localStorage.clear(name);
            }

        }
    }]);
</script>
</body>
</html>