<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>大屏互动-制作中</title>
    <link rel="stylesheet" href="../../static/interaction/mui/mui.min.css">
    <link rel="stylesheet" href="../../static/interaction/css/common.css">
    <link rel="stylesheet" href="../../static/interaction/css/make.css">
</head>

<body class="mui-ios mui-ios-9 mui-ios-9-1">
    <!--裁剪部分-->
    <div class="htmleaf-container">
        <div id="clipArea"></div>
        <div class="footer">
            <div>
                <div class="mui-row color_w">
                    <div class="mui-col-xs-6 mui-text-left"><span id="cancle">取消</span></div>
                    <div class="mui-col-xs-6 mui-text-right"><span id="finish">完成</span></div>
                </div>
            </div>
        </div>
    </div>
    <!--头部-->
    <header>

        <a class="mui-pull-left btn_share" id="goBack">
            <img src="//img.aimoge.com/FuGSEC9x9qNjuZhJ4gYjJ_81iPjf" alt="返回">
        </a>
        <h1 class="mui-title">制作中</h1>
    </header>
    <div class="mui-content">
        <div id="two">
            <div class="mui-content-padded">
                <div class="mui-row">
                    <div class="mui-col-xs-5">
                        <button type="button" class="mui-btn mui-btn-outlined btn" id="make_btn">
                        1.制作
                    </button>
                    </div>
                    <div class="mui-col-xs-2"></div>
                    <div class="mui-col-xs-5">
                        <button type="button" class="mui-btn mui-btn-outlined btn" id="choice_btn">
                        2.选择柜机
                    </button>
                    </div>
                </div>
                <div class="show " id="show">
                    <div class="mui-card">
                        <div class="mui-card-header mui-card-media">
                            <div id="uploadBox">
                                <a href="javascript:void(0);" id="upload">
                                    <button type="button" class="mui-btn mui-btn-outlined upload_btn">
                                  上传图片
                                </button>
                                    <input id="file" type="file" accept="image/*" multiple />
                                </a>
                                <p class="font_14">建议上传1M以上 清晰度高的图片</p>
                            </div>
                            <div id="error">
                                <p class="font_14">咣咣，上传失败/(ㄒoㄒ)/~~</p>
                                <div class="mui-text-center">
                                    <button type="button" class="mui-btn mui-btn-outlined upload_btn margin20" id="retry">重试</button>
                                </div>
                                <a href="javascript:void(0);" id="reelect" class="font_14"><label for="file">重选作品
                            </label></a>
                            </div>
                            <div id="photo"></div>
                        </div>
                        <div class="mui-card-content">
                            <div class="text ">
                                <p class="txt1 font_14">点击输入文字</p>
                                <div class="text_1">
                                    <textarea maxlength="140" id="text" rows="2"></textarea>
                                    <p id="num1" class="mui-text-right font_14"><span id="word">0</span>/140</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="cabinet" class="margin45" style="display: none">
                    <ul class="mui-table-view line_h30">
                        <li class="mui-table-view-cell">
                            <div class="mui-row ">
                                <div class="mui-col-xs-2 mui-text-center">
                                    <div style="width:18px;height:18px; display: inline-block">
                                        <img class="mui-pull-left" src="//img.aimoge.com/FjHjVjKxuwijQBc6c_9jq9Ru0v9c" width="100%" height="100%">
                                    </div>
                                </div>
                                <div class="mui-col-xs-8 margin-5" id="choose">
                                    <p class="mui-ellipsis">请选择城市</p>
                                </div>
                                <div class="mui-col-xs-2 mui-text-right">
                                    <div style="width:18px;height:18px;display: inline-block">
                                        <img src="//img.aimoge.com/FnvoecOAQ0w2pmYfw0BfkPjXlvHC" width="100%" height="100%">
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>
                    <ul class="mui-table-view margin5">
                        <li class="mui-table-view-cell">
                            <div class="mui-row">
                                <div class="mui-col-xs-2 mui-text-center">
                                    <div style="width:18px;height: 18px; display: inline-block">
                                        <img src="//img.aimoge.com/FgsAPXW3eFt4MN3pHyGaq6_B-fjQ" alt="" width="100%" height="100%">
                                    </div>

                                </div>
                                <div class="mui-col-xs-10">
                                    <p class="mui-ellipsis">选择展示日期</p>
                                </div>
                            </div>
                        </li>
                        <li class="mui-table-view-cell">
                            <div class="mui-row" id="chooseDate">
                                <div class="mui-col-xs-4 mui-text-center">开始时间</div>
                                <div class="mui-col-xs-4 mui-text-center">------</div>
                                <div class="mui-col-xs-4 mui-text-center">结束时间</div>
                            </div>
                        </li>
                    </ul>
                    <div class="mui-row margin145">
                        <div class="mui-col-xs-3 mui-text-right">
                            <div style="width:15px;height:15px; display: inline-block;margin-right: 5px;margin-top: 3px">
                                <img src="//img.aimoge.com/FhK_8jHkPbHUvC7yuZgnh5XzAmfy" alt="" width="100%" height="100%" id="agreement">
                            </div>
                        </div>
                        <div class="mui-col-xs-9">
                            <a href="/adinteraction/agreement" class="agreement">同意柜机屏幕展示协议</a>
                        </div>
                    </div>

                </div>

                <button type="button" class="mui-btn mui-btn-primary mui-btn-block bottom" id="nextBtn">下一步</button>
                <button type="button" class="mui-btn mui-btn-primary mui-btn-block bottom" id="submit">确认提交</button>
            </div>
            <div id="time">
                <div class="mui-row mui-table-view-cell">
                    <div class="mui-col-xs-6 font_14" id="NO">
                        取消
                    </div>
                    <div class="mui-col-xs-6 blue mui-text-right font_14" id="confirm">
                        确定
                    </div>
                </div>
                <ul class="mui-table-view" id="date">
                    <li class="mui-table-view-cell mui-text-center">
                        <div class="mui-row" id="week1">
                            <div class="mui-col-xs-5 mui-text-right">2017-7-9</div>
                            <div class="mui-col-xs-2">到</div>
                            <div class="mui-col-xs-5 mui-text-left">2017-7-9</div>
                        </div>
                    </li>
                    <li class="mui-table-view-cell  mui-text-center">
                        <div class="mui-row" id="week2">
                            <div class="mui-col-xs-5 mui-text-right">2017-7-9</div>
                            <div class="mui-col-xs-2">到</div>
                            <div class="mui-col-xs-5 mui-text-left">2017-7-9</div>
                        </div>
                    </li>

                    <li class="mui-table-view-cell  mui-text-center">
                        <div class="mui-row" id="week3">
                            <div class="mui-col-xs-5 mui-text-right">2017-7-9</div>
                            <div class="mui-col-xs-2">到</div>
                            <div class="mui-col-xs-5 mui-text-left">2017-7-9</div>
                        </div>
                    </li>
                    <li class="mui-table-view-cell  mui-text-center">
                        <div class="mui-row" id="week4">
                            <div class="mui-col-xs-5 mui-text-right">2017-7-9</div>
                            <div class="mui-col-xs-2">到</div>
                            <div class="mui-col-xs-5 mui-text-left">2017-7-9</div>
                        </div>
                    </li>

                </ul>
            </div>
        </div>
        <div id="choice" class="mui-content" style="display: none;padding-top: 8%">
            <div class="mui-content-padded">
                <div class="mui-row mui-text-center color_w">
                    <div class="mui-col-xs-4 mui-text-right">朕要包下全</div>
                    <div class="mui-col-xs-4 mui-h2">南京</div>
                    <div class="mui-col-xs-4 mui-text-left">格格货栈</div>
                </div>
                <div class="show margin8">
                    <ul id="cityList">
                        <li class="mui-table-view-cell" value="3201">南京</li>
                        <li class="mui-table-view-cell" value="1101">北京</li>
                        <li class="mui-table-view-cell" value="3101">上海</li>
                    </ul>
                </div>
            </div>

        </div>
    </div>
    <script src="https://cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script>
    <script src="../../static/interaction/js/iscroll-zoom.js"></script>
    <script src="../../static/interaction/js/hammer.js"></script>
    <script src="../../static/interaction/js/lrz.all.bundle.js"></script>
    <script src="../../static/interaction/js/jquery.photoClip1.js"></script>
    <script src="../../static/interaction/js/date.js"></script>


    <script type="text/javascript">
        window.token = 'MlZsy_bZg4Sg5zLmdjBV4nZ35EWxXfwWIznsSViW:U4tfLAvt-rhNyyCweZhEJEAo30w=:eyJzY29wZSI6Im1vZ2UiLCJkZWFkbGluZSI6Mjg2MTExNTA3NCwiY2FsbGJhY2tVcmwiOiJodHRwOlwvXC9hcGkuYWltb2dlLmNvbVwvdjFcL3VwbG9hZFwvY2FsbGJhY2siLCJjYWxsYmFja0JvZHkiOiJuYW1lPSQoZm5hbWUpJmtleT0kKGtleSkmaGFzaD0kKGV0YWcpJnNpemU9JChmc2l6ZSkmd2lkdGg9JChpbWFnZUluZm8ud2lkdGgpJmhlaWdodD0kKGltYWdlSW5mby5oZWlnaHQpJm1pbWV0eXBlPSQobWltZVR5cGUpJnNpZD0xODYxODE0Mjc2NCZ1aWQ9MTg2MTgxNDI3NjQmc291cmNlPSQoeDpzb3VyY2UpIiwiZGV0ZWN0TWltZSI6MX0=';
        var imgsrc = "",
            photo = "",
            cityId = "",
            flag = false,
            startDate = "",
            endDate = "";

        window.sessionStorage.setItem("id", cityId);

        function submit() {
            let content = $("#text").val(),
                city_id = cityId,
                start_date = startDate,
                end_date = endDate,
                isflag = flag;
            image = imgsrc;
            if (content == "") {
                msgAlert("warning", "请输入您想要说的话");
                return false;
            };
            if (city_id == "") {
                msgAlert("warning", "请选择您要展示的城市");
                return false;
            };
            if (start_date == "" && end_date == "") {
                msgAlert("warning", "请选择展示的日期");
                return false;
            };
            if (image == "") {
                msgAlert("warning", "请您上传一张图片");
                return false;
            };
            if (!flag) {
                msgAlert("warning", "抱歉您还没有同意展示协议");
                return false;
            };

            let data = {
                content: content,
                image: image,
                city_id: cityId,
                start_date: start_date,
                end_date: end_date,
            };
            console.log(data);
            postData(data);
        }

        function postData(data) {
            $.ajax({
                type: "post",
                data: JSON.stringify(data),
                url: window.config.API + "/media/adinteraction",
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                xhrFields: {
                    withCredentials: true
                },
                success: function(data) {
                    console.log(data);
                    if (data.status == 0) {
                        console.log(data, '上传成功');
                        location.href = "/adinteraction/examine";
                         window.sessionStorage.setItem("flag", 0);
                    }
                },
                error: function(data) {
                    console.log('上传失败')
                    $("#uploadBox").hide();
                    $("#error").css({
                        "display": "flex"
                    });
                    $("#error").show();
                    return false;
                }
            });
        }
        window.config = {
            'API': '//api.dev.aimoge.com/v1'
        };
        //弹出窗口
        function msgAlert(type, msg) {
            $('.msg_' + type).html(msg);
            $('.msg_' + type).animate({
                'top': 0
            }, 500);
            setTimeout(function() {
                $('.msg_' + type).animate({
                    'top': '-30px'
                }, 500)
            }, 2000);
        }

        $(document).ready(function() {
            var htmlstyle = "<style>body{padding:0;margin:0;}.msg{color:#FFF;width:100%;height:30px;text-align:center;font-size:14px;line-height:30px;position:fixed;top: -30px;z-index:20;}" +
                ".msg_success{background-color:#1fcc6c;}" +
                ".msg_warning{background-color:#e94b35;}" +
                ".msg_primary{background-color:#337ab7;}" +
                ".msg_info{background-color:#5bc0de;}</style>";
            $('head').append(htmlstyle);
            $('body').prepend('<div class="msg msg_success"></div>' +
                '<div class="msg msg_warning"></div>' +
                '<div class="msg msg_primary"></div>' +
                '<div class="msg msg_info"></div>');
        });
        //上传图片到七牛
        function post_img(data) {
            // $("#showshare img").attr("src",data);
            var blobBin = atob(data.split(',')[1]);
            var array = [];
            for (var i = 0; i < blobBin.length; i++) {
                array.push(blobBin.charCodeAt(i));
            }
            var file = new Blob([new Uint8Array(array)], {
                type: 'image/png'
            });
            // Pic = data.replace(/^data:image\/(png|jpg);base64,/, "");
            var formdata = new FormData();
            formdata.append("file", file);
            formdata.append("token", window.token);
            formdata.append("x:source", "dazhongdianping");
            $.ajax({
                url: location.protocol == "http:" ? 'http://upload.qiniu.com' : 'https://up.qbox.me',
                type: "POST",
                data: formdata,
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                processData: false,
                contentType: false,
                success: function(respond) {
                    imgsrc = respond.name;
                    console.log(imgsrc);

                }
            }).done(function(respond) {
                imgsrc = respond.name;
            });


        };
        $(function() {
             let h=$(window).height();
            $('body').css({'height':h});
            //文字限制
            $('#text').keyup(function() {
                var len = $(this).val().length;
                if (len > 139) {
                    msgAlert("warning", "您输入超出了字数限制");
                }
                var num = 140 - len;
                $("#word").text(len);
            });
            $("#upload").on("click", function() {
                $(".htmleaf-container").fadeIn(300);

                $("#photo").show();

            });
            $("#cancle").on("click", function() {
                $(".htmleaf-container").fadeOut(300);
                $("#photo").hide();
            });

            $(".txt1").on("click", function() {
                $(this).hide();
                $(".text_1").show();
            });
            //删除图片
            $("#photo").on("click", function() {
                $(this).empty();
                $(".htmleaf-container").fadeIn(300);
                $("#photo").show();
                $("#file").click();
            });
            //        点击1.制作
            $("#make_btn").on("click", function() {
                $("#choice_btn").removeClass("active");
                $(".mui-btn-primary").removeClass("margin12");
                $(this).toggleClass("active");
                if ($("#show").is(":hidden")) {
                    $("#show").show();
                    $("#cabinet").hide();
                    $(".mui-title").text("制作中");
                };
                $("#nextBtn").show();
                $("#submit").hide();

            });
            //      选择柜机
            $("#choice_btn").on("click", function() {
                if ($("#text").val() == "") {
                    msgAlert("warning", "请输入您想要说的话");
                    return false;
                };
                if (imgsrc == "") {
                    msgAlert("warning", "请您上传一张图片");
                    return false;
                };
                $("#make_btn").removeClass("active");
                $(this).toggleClass("active");
                $("#show").hide();
                $(".mui-btn-primary").toggleClass("margin12");
                $("#cabinet").show();
                $(".mui-title").text("选择快递柜");
                  $("#nextBtn").hide();
                $("#submit").show();
            });
            //      选择货栈
            $("#choose").on("click", function() {
                $("#goBack img").hide();
                $("#two").hide();
                $("#choice").show();
                return false;
            });
            //获取城市id
            $("#cityList>li").each(function() {
                $(this).on("click", function() {
                    cityId = $(this).val();
                    $("#goBack img").show();
                    $("#choose p").text($(this).text());
                    $("#two").show();
                    $("#choice .mui-h2").text($(this).text());
                    $("#choice").hide();
                    console.log(cityId);
                    window.sessionStorage.setItem("id", $(this).val());
                })
            });
            //        选择时间
            $("#chooseDate").on("click", function() {
                $("#time").show();
                $("#time").animate({
                    bottom: '0'
                }, "slow");
            });
            //        取消选择时间
            $("#NO").on("click", function() {
                $("#time").animate({
                    bottom: '-30%'
                }, "slow", function() {
                    $("#time").hide();
                });
                startDate = "";
                endDate = "";
                $("#chooseDate .mui-col-xs-4").eq(0).text("开始时间");
                $("#chooseDate .mui-col-xs-4").eq(2).text("结束时间");

            });
            //确定选择时间
            $("#confirm").on("click", function() {
                $("#time").animate({
                    bottom: '-30%'
                }, "slow", function() {
                    $("#time").hide();
                });

            });
            //        返回上一个页面
            $("#goBack").on("click", function() {
                location.href = "/adinteraction";
            });
            //        同意协议

            $("#agreement").on("click", function() {

                if (!flag) {
                    $("#agreement").attr({
                        src: "//img.aimoge.com/FtRcBl62d6oHvi4N6OfL2xSYkREC",
                        alt: "选中"
                    });
                    flag = true;
                } else {
                    $("#agreement").attr({
                        src: "//img.aimoge.com/FhK_8jHkPbHUvC7yuZgnh5XzAmfy",
                        alt: "不选中"
                    });
                    flag = false;
                }
            });
            // 下一步 提交数据
            $("#nextBtn").on("click", function() {
                if ($("#text").val() == "") {
                    msgAlert("warning", "请输入您想要说的话");
                    return false;
                };
                if (imgsrc == "") {
                    msgAlert("warning", "请您上传一张图片");
                    return false;
                };
                $("#make_btn").removeClass("active");
                $(this).toggleClass("active");
                $("#show").hide();
                $(".mui-btn-primary").toggleClass("margin12");
                $("#cabinet").show();
                $(".mui-title").text("选择快递柜");
                $(this).hide();
                $("#submit").show();

            });
            //提交数据
              $("#submit").on("click", function() {
                submit();
            });
            // 重试再次提交数据
            $("#retry").on("click", function() {
                submit();
            });
            //重新选择作品
            $("#reelect").on("click", function() {
                $(".htmleaf-container").fadeIn(300);
                $("#photo").show();
                $("#file").on("click", function() {});
            });
            //裁剪图片
            var clipArea = new bjj.PhotoClip("#clipArea", {
                size: [310, 290],
                outputSize: [580, 620],
                file: "#file",
                view: "#photo",
                ok: "#finish",
                loadStart: function() {
                    console.log("照片读取中");
                },
                loadComplete: function() {
                    console.log("照片读取完成");
                },
                clipFinish: function(dataURL) {
                    imgsrc = post_img(dataURL)
                }
            });
            $("#finish").on("click", function() {
                $("#photo").css({
                    'background-color': 'none',
                    'background-size': '100%'
                });
                $("#uploadBox").hide();
                $("#error").hide();
                $(".htmleaf-container").hide();
            });
            //把时间渲染到页面上
            let week1 = setValAndReqNow(2);
            let week2 = setValAndReqNow(3);
            let week3 = setValAndReqNow(4);
            let week4 = setValAndReqNow(5);
            $("#week1 .mui-col-xs-5").eq(0).text(getFormatData(week1.monday));
            $("#week1 .mui-col-xs-5").eq(1).text(getFormatData(week1.sunday));
            $("#week2 .mui-col-xs-5").eq(0).text(getFormatData(week2.monday));
            $("#week2 .mui-col-xs-5").eq(1).text(getFormatData(week2.sunday));
            $("#week3 .mui-col-xs-5").eq(0).text(getFormatData(week3.monday));
            $("#week3 .mui-col-xs-5").eq(1).text(getFormatData(week3.sunday));
            $("#week4 .mui-col-xs-5").eq(0).text(getFormatData(week4.monday));
            $("#week4 .mui-col-xs-5").eq(1).text(getFormatData(week4.sunday));
            //选取日期
            $("#date li").each(function() {

                $(this).on("click", function() {
                    $("#date li").each(function() {
                        $("#date li").removeClass("dateActive");
                    });
                    $("#time").animate({
                        bottom: '-20%'
                    }, "slow", function() {
                        $("#time").hide();
                    });
                    $(this).toggleClass("dateActive");
                    startDate = $(this).children().children().eq(0).text();
                    endDate = $(this).children().children().eq(2).text();
                    $("#chooseDate .mui-col-xs-4").eq(0).text(startDate);
                    $("#chooseDate .mui-col-xs-4").eq(2).text(endDate);
                })
            })
        })

    </script>

</body>

</html>
